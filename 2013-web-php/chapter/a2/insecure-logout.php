<?php
$isAuthenticated = false;
if(0 < $_COOKIE['logout_user_id']) {
	$isAuthenticated = true;
}
else if(isset($_POST['submit'])) {
	require_once('../../config/database.php');
	$con = mysqli_connect($host, $user, $password, $database, $port, $socket) or die("Database Connection error.<br />Please review the settings under /config/database.php<br />The current settings are<br />host: ".$host."<br />user: ".$user."<br />password: ".$password.'<br />db: '.$database.'<br />port: '.$port.'<br />socket: '.$socket);
	$email = $_POST['email'];
	$password = $_POST['password'];
	$query = "SELECT user_id FROM victim_user WHERE email = '".$email."' AND password = '".$password."'";
	$result = mysqli_query($con, $query) or die(mysqli_error($con)."<br />The query is<br />".$query);
	if(0 < $result->num_rows) {
		$row = $result->fetch_assoc();
		setcookie('logout_user_id', $row['user_id'], time()+(3600*24*30*365), "/", "localhost");
		$isAuthenticated = True;
	}
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
	<?php require_once('../../include/head-include.php'); ?>
	<title>Insecure Logout | Broken Authentication &amp; Session Management | LearByExploit</title>
</head>
<body>
	<!-- wrapper -->
	<div class="wrapper">
		<?php require_once('../../include/header.php'); ?>
		<!-- shell -->
		<div class="shell">
			<!-- main -->
			<div class="main">
				<section class="content">
					<?php
						if($isAuthenticated) {
							echo "<b>Welcome!</b><br />Now you may logout<br />";
							echo "<a href=\"".$HOME."chapter/a2/fake-logout-handler.php\">Logout</a>";
						}
						else {
							require_once('../../config/database.php');
						 	$con = mysqli_connect($host, $user, $password, $database, $port) or die("Database Connection error.<br />Please review the settings under /config/database.php<br />The current settings are<br />host: ".$host."<br />user: ".$user."<br />password: ".$password.'<br />db: '.$database.'<br />port: '.$port.'<br />socket: '.$socket);
						 	$query = 'SELECT email, password FROM victim_user';
							$result = mysqli_query($con, $query) or die(mysqli_error($con)."<br />The query is<br />".$query);
							if(0 < $result->num_rows) {						
								echo "<table border='1'><tr><td>Email</td><td>Password</td></tr>";
								while($row = $result->fetch_assoc()) {
									echo "<tr><td>".$row['email']."</td><td>".$row['password']."</td></tr>";
								}
								echo "</table>";
							}
						?>
						<form method="POST">
							<table>
								<tr><td><input type="text" name="email" placeholder="foo@example.com" /></td></tr>
								<tr><td><input type="password" placeholder="password@123" name="password" /></td></tr>
								<tr><td><input type="submit" value=" Login " name="submit" /></td></tr>
							</table>
						</form>
						<?php
						}					
					?>
					<br /><br />
					<hr />
					<br />
					<h3>Lessons:</h3>
					<ul>
						<li>Securely invalidate session cookie</li>
						<li>Check for session token in all the authenticated requests</li>
					</ul>
				</section>
			</div>
			<!-- end of main -->
		</div>
		<!-- end of shell -->	
		<?php require_once('../../include/footer.php'); ?>
	</div>
	<!-- end of wrapper -->
</body>
</html>