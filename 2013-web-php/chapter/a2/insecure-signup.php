<?php
$isSignedUp = false;
if(isset($_POST['submit'])) {
	if(! empty($_POST['email']) && !empty($_POST['password'])) {
		require_once('../../config/database.php');
	 	$con = mysqli_connect($host, $user, $password, $database, $port) or die("Database Connection error.<br />Please review the settings under /config/database.php<br />The current settings are<br />host: ".$host."<br />user: ".$user."<br />password: ".$password.'<br />db: '.$database.'<br />port: '.$port.'<br />socket: '.$socket);
	 	$query = "SELECT email FROM victim_user where email ='".$_POST['email']."'";
	 	$result = mysqli_query($con, $query);
	 	if(0 < $result->num_rows) {
	 		while($row = $result->fetch_assoc()) {
	 			$update_query = "UPDATE victim_user set password = '".$_POST['password']."' WHERE email = '".$_POST['email']."'";
	 			mysqli_query($con, $update_query);
	 		}
	 		$isSignedUp = true;
	 	}
	 	else {
		 	$query = 'INSERT INTO victim_user(email, password) VALUES ("'.$_POST["email"].'","'.$_POST["password"].'");';
			$result = mysqli_query($con, $query) or die(mysqli_error($con));
			if($result)
				$isSignedUp = true;
		}
	}
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
	<?php require_once('../../include/head-include.php'); ?>
	<title>Insecure Signup | Broken Authentication &amp; Session Management | LearByExploit</title>
</head>
<body>
	<!-- wrapper -->
	<div class="wrapper">
		<?php require_once('../../include/header.php'); ?>
		<!-- shell -->
		<div class="shell">
			<!-- main -->
			<div class="main">
				<section class="content">
					<?php if($isSignedUp)
						echo "Registered. Your username &amp; password has been sent you by email for your future reference.";
					?>
					<h3>Sing Up</h3>
					<form method="POST">
						<table>
							<tr>
								<td>Email Address:</td>
								<td><input type="text" name="email" /></td>
							</tr>
							<tr>
								<td>Password:</td>
								<td><input type="password" name="password" /></td>
							</tr>
							<tr>
								<td colspan="2">
									<input type="submit" value="Singup" name="submit" />
								</td>
						</table>
					</form>
					<br /><br />
					<h3>Current Registered Users:</h3>
					<?php
						require_once('../../config/database.php');
					 	$con = mysqli_connect($host, $user, $password, $database, $port) or die("Database Connection error.<br />Please review the settings under /config/database.php<br />The current settings are<br />host: ".$host."<br />user: ".$user."<br />password: ".$password.'<br />db: '.$database.'<br />port: '.$port.'<br />socket: '.$socket);
					 	$query = 'SELECT email, password FROM victim_user';
						$result = mysqli_query($con, $query) or die(mysqli_error($con)."<br />The query is<br />".$query);
						if(0 < $result->num_rows) {						
							echo "<table border='1'><tr><td>Email</td><td>Password</td></tr>";
							while($row = $result->fetch_assoc()) {
								echo "<tr><td>".$row['email']."</td><td>".$row['password']."</td></tr>";
							}
							echo "</table>";
						}
					?>
					<br />
					<h3>Lessons:</h3>
					<ul>
						<li>Password stored in cleartext in database</li>
						<li>Plaintext password is shared outside the app such as email</li>
						<li>Account override</li>
				</section>
			</div>
			<!-- end of main -->
		</div>
		<!-- end of shell -->	
		<?php require_once('../../include/footer.php'); ?>
	</div>
	<!-- end of wrapper -->
</body>
</html>