<?php
require_once('../../config/database.php');
$con = mysqli_connect($host, $user, $password, $database, $port, $socket) or die("Database Connection error.<br />Please review the settings under /config/database.php<br />The current settings are<br />host: ".$host."<br />user: ".$user."<br />password: ".$password.'<br />db: '.$database.'<br />port: '.$port.'<br />socket: '.$socket);
if(isset($_POST['submit'])) {
	$name = $_POST['full_name'];
	$email = $_POST['email'];
	$phone = $_POST['phone'];
	
	$query = "UPDATE user SET full_name = '$name', email = '$email', phone = '$phone'";
	$result = mysqli_query($con, $query);
}
$query = "SELECT full_name, email, phone FROM user WHERE user_id = 1";
$result = mysqli_query($con, $query) or die("Error in query<br />".mysqli_error($con)."<br />The query is<br />".$query);
?>
<!DOCTYPE html>
<html lang="en">
<head>
	<?php require_once('../../include/head-include.php'); ?>
	<title>OWASP Top 10 in php | The darkw3b</title>
</head>
<body>
	<!-- wrapper -->
	<div class="wrapper">
		<?php require_once('../../include/header.php'); ?>
		<!-- shell -->
		<div class="shell">
			<!-- main -->
			<div class="main">
				<section class="content">
					<h3>Challenge:</h3>
					<p>Update Profile for user #1. SQL Inject the query.</p>
					<?php if(isset($_POST['submit'])) { ?>
						<p>Profile Updated.</p>
					<?php
					}
					?>
					<?php
					if(0 < $result->num_rows) {
						$row = $result->fetch_assoc();
					?>
					<form method="POST">
						<table>
							<tr>
								<td>Full Name</td>
								<td><input type="text" name="full_name" value="<?php echo $row['full_name']; ?>" /></td>
							</tr>
							<tr>
								<td>Email</td>
								<td><input type="text" name="email" value="<?php echo $row['email']; ?>" /></td>
							</tr>
							<tr>
								<td>Phone</td>
								<td><input type="text" name="phone" value="<?php echo $row['phone']; ?>" /></td>
							</tr>
							<tr>
								<td colspan="2">
									<input type="submit" value=" Update " name="submit" />
								</td>
							</tr>
						</table>
					</form>
					<?php 
					}
					else {
					?>
					<p>There was something unexpected. Did you delete Users? Reset the database.</p>
					<?php
					}
					?>
					<hr />
					<h3>Background</h3>
					<p> The code looks something like </p>
					<pre>
$email = $_GET['email'];
$query = "SELECT user_id, full_name, phone FROM user WHERE email = '".$email."'";
					</pre>
					<h3>Solution</h3>
					<p>foo' UNION SELECT 1, 2, 3'
				</section>
			</div>
			<!-- end of main -->
		</div>
		<!-- end of shell -->	
		<?php require_once('../../include/footer.php'); ?>
	</div>
	<!-- end of wrapper -->
</body>
</html>